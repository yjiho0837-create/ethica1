<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ethica</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { margin: 0; font-family: 'Poppins', sans-serif; background-color: #CEF8FF; color: #333; }
    .screen { display: none; padding: 20px; }
    .active { display: block; }
    .logo { text-align: center; font-size: 36px; font-weight: bold; margin-top: 20px; }
    .button-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 40px; padding: 0 40px; }
    .nav-button { background-color: white; border-radius: 15px; padding: 30px; text-align: center; font-weight: bold; font-size: 18px; box-shadow: 2px 2px 10px rgba(0,0,0,0.1); cursor: pointer; }
    .search-bar { width: 100%; padding: 10px; font-size: 16px; margin-bottom: 20px; border-radius: 10px; border: none; }
    .company-list, .history-list, .post-list { list-style: none; padding: 0; }
    .company-item, .product-item, .post { background: white; padding: 15px; margin-bottom: 10px; border-radius: 10px; box-shadow: 1px 1px 6px rgba(0,0,0,0.05); }
    #reader { width: 100%; max-width: 400px; margin: auto; }
    .info-icons { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
    .icon { background: white; padding: 10px; border-radius: 10px; }
    .back-button { margin-top: 20px; background: #fff; border-radius: 10px; padding: 10px 20px; display: inline-block; cursor: pointer; box-shadow: 1px 1px 4px rgba(0,0,0,0.1); }
    pre { white-space: pre-wrap; }
  </style>
</head>
<body>

<!-- Home -->
<div id="home" class="screen active">
  <div class="logo">Ethica</div>
  <div class="button-grid">
    <div class="nav-button" onclick="navigate('search')">Search</div>
    <div class="nav-button" onclick="navigate('scan')">Scan</div>
    <div class="nav-button" onclick="navigate('mypage')">My Page</div>
    <div class="nav-button" onclick="navigate('community')">Community</div>
  </div>
</div>

<!-- Search -->
<div id="search" class="screen">
  <input type="text" id="search-input" placeholder="ë¸Œëœë“œ ë˜ëŠ” ì œí’ˆëª…ì„ ê²€ìƒ‰í•˜ì„¸ìš”..." class="search-bar" />
  <ul id="search-results" class="company-list"></ul>
  <div class="back-button" onclick="navigate('home')">â† í™ˆìœ¼ë¡œ</div>
</div>

<!-- Information -->
<div id="information" class="screen">
  <h2 id="company-name">ì œí’ˆ ì´ë¦„</h2>
  <div class="info-icons" id="info-tags"></div>
  <pre id="company-desc">ì œí’ˆ ìƒì„¸ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</pre>
  <div class="back-button" onclick="navigate('search')">â† ë’¤ë¡œ</div>
</div>

<!-- Scan -->
<div id="scan" class="screen">
  <h2>ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”</h2>
  <div id="reader"></div>
  <h3 style="margin-top: 30px;">ë˜ëŠ” ë°”ì½”ë“œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</h3>
  <input type="text" id="manual-barcode" placeholder="ë°”ì½”ë“œ ìˆ«ì ì…ë ¥" class="search-bar" />
  <button onclick="manualBarcodeSearch()" class="nav-button">ì¡°íšŒí•˜ê¸°</button>
  <div class="back-button" onclick="stopScanner();navigate('home')">â† í™ˆìœ¼ë¡œ</div>
</div>

<!-- Product Analysis -->
<div id="product" class="screen">
  <h2 id="product-name">ì œí’ˆ ì´ë¦„</h2>
  <p id="product-company">ë¸Œëœë“œëª…</p>
  <div class="info-icons">
    <div class="icon">ğŸ’§ ë¬¼ ì‚¬ìš© ì ˆê°</div>
    <div class="icon">ğŸŒ íƒ„ì†Œ ì €ê°</div>
    <div class="icon">ğŸ”„ ìœ¤ë¦¬ì  ìƒì‚°</div>
  </div>
  <div class="back-button" onclick="navigate('home')">â† í™ˆìœ¼ë¡œ</div>
</div>

<!-- My Page -->
<div id="mypage" class="screen">
  <h2>ë‚˜ì˜ ì—ì½” ì†Œë¹„ ê¸°ë¡</h2>
  <p>ğŸŒ¿ ì´ ì ˆì•½ëœ íƒ„ì†Œ: 25kg</p>
  <p>ğŸ’§ ë¬¼ ì ˆì•½ëŸ‰: 150L</p>
  <ul class="history-list">
    <li class="product-item">Lush ìƒ´í‘¸ - 2025/11/06</li>
    <li class="product-item">The Body Shop í´ë Œì € - 2025/11/03</li>
  </ul>
  <div class="back-button" onclick="navigate('home')">â† í™ˆìœ¼ë¡œ</div>
</div>

<!-- Community -->
<div id="community" class="screen">
  <h2>ì»¤ë®¤ë‹ˆí‹°</h2>
  <ul class="post-list">
    <li class="post">ğŸ“ Lush ì œí’ˆ ë„ˆë¬´ ì¢‹ì•„ìš”!</li>
    <li class="post">ğŸ§´ ì–´ë–¤ í´ë Œì €ê°€ ê°€ì¥ ì¹œí™˜ê²½ì ì¼ê¹Œìš”?</li>
  </ul>
  <div class="back-button" onclick="navigate('home')">â† í™ˆìœ¼ë¡œ</div>
</div>

<!-- SCRIPT -->
<script>
  function navigate(screen) {
    document.querySelectorAll('.screen').forEach(div => div.classList.remove('active'));
    document.getElementById(screen).classList.add('active');
    if (screen === 'scan') startScanner();
    else stopScanner();
  }

  let scanner;
  function startScanner() {
    scanner = new Html5Qrcode("reader");
    scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
      async (decodedText) => {
        stopScanner();
        fetchProductData(decodedText);
      }
    ).catch(err => console.error("ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨", err));
  }

  function stopScanner() {
    if (scanner) scanner.stop().then(() => scanner.clear());
  }

  function manualBarcodeSearch() {
    const code = document.getElementById('manual-barcode').value.trim();
    if (code.length === 0) {
      alert("ë°”ì½”ë“œ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    stopScanner();
    fetchProductData(code);
  }

  async function fetchProductData(barcode) {
    try {
      const res = await fetch(`https://world.openbeautyfacts.org/api/v0/product/${barcode}.json`);
      const data = await res.json();
      if (data.status === 1) {
        const product = data.product;
        document.getElementById('product-name').innerText = product.product_name || "ì´ë¦„ ì—†ìŒ";
        document.getElementById('product-company').innerText = product.brands || "ë¸Œëœë“œ ì •ë³´ ì—†ìŒ";
        navigate('product');
      } else {
        alert(`âŒ í•´ë‹¹ ë°”ì½”ë“œì˜ ìƒí’ˆ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. (${barcode})`);
        navigate('home');
      }
    } catch (error) {
      console.error("API í˜¸ì¶œ ì˜¤ë¥˜:", error);
      alert('ğŸš¨ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì˜ëª»ëœ ë°”ì½”ë“œì…ë‹ˆë‹¤.');
      navigate('home');
    }
  }

  const searchInput = document.getElementById('search-input');
  const resultsList = document.getElementById('search-results');
  let debounceTimeout;
  searchInput?.addEventListener('input', () => {
    const query = searchInput.value.trim();
    if (debounceTimeout) clearTimeout(debounceTimeout);
    if (query.length === 0) {
      resultsList.innerHTML = '';
      return;
    }
    debounceTimeout = setTimeout(() => fetchSearchResults(query), 500);
  });

  async function fetchSearchResults(query) {
    const url = `https://world.openbeautyfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&json=1`;
    try {
      const response = await fetch(url);
      const data = await response.json();
      const products = data.products.slice(0, 10);
      resultsList.innerHTML = '';
      if (products.length === 0) {
        resultsList.innerHTML = '<li class="company-item">ğŸ” ê²°ê³¼ ì—†ìŒ</li>';
        return;
      }
      products.forEach(product => {
        const li = document.createElement('li');
        li.className = 'company-item';
        li.textContent = `${product.product_name || 'ì´ë¦„ ì—†ìŒ'} (${product.brands || 'ë¸Œëœë“œ ì •ë³´ ì—†ìŒ'})`;
        li.onclick = () => loadProductDetails(product.code);
        resultsList.appendChild(li);
      });
    } catch (err) {
      resultsList.innerHTML = '<li class="company-item">âŒ ì˜¤ë¥˜ ë°œìƒ</li>';
    }
  }

  function cleanTag(tag) {
    if (!tag) return '';
    return tag.replace(/^[a-z]{2}:/, '').replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
  }

  async function loadProductDetails(code) {
    const res = await fetch(`https://world.openbeautyfacts.org/api/v0/product/${code}.json`);
    const data = await res.json();
    if (data.status === 1) {
      const product = data.product;
      document.getElementById('company-name').innerText = product.product_name || 'ì´ë¦„ ì—†ìŒ';
      const infoTags = document.getElementById('info-tags');
      const descBox = document.getElementById('company-desc');
      infoTags.innerHTML = '';
      let desc = '';

      if (product.brands) {
        infoTags.innerHTML += `<div class="icon">ğŸ·ï¸ Brand: ${product.brands}</div>`;
      }
      if (product.categories_tags?.length) {
        const cats = product.categories_tags.map(cleanTag).join(', ');
        infoTags.innerHTML += `<div class="icon">ğŸ“¦ Categories: ${cats}</div>`;
      }
      if (product.labels_tags?.length) {
        const labels = product.labels_tags.map(cleanTag).join(', ');
        infoTags.innerHTML += `<div class="icon">âœ… Labels: ${labels}</div>`;
      }
      if (product.ingredients_text) {
        desc += `ğŸ“‹ Ingredients:\n${product.ingredients_text}\n\n`;
      }
      if (product.labels_tags?.includes('en:organic')) {
        infoTags.innerHTML += `<div class="icon">ğŸŒ± Organic Product</div>`;
      }
      if (product.labels_tags?.includes('en:fair-trade')) {
        infoTags.innerHTML += `<div class="icon">ğŸ¤ Fair Trade</div>`;
      }

      descBox.innerText = desc.trim();
      navigate('information');
    }
  }
</script>
</body>
</html>
